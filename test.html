<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malafrena 系统测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .pass {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        .fail {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
    </style>
</head>
<body>
    <h1>Malafrena 系统测试报告</h1>
    
    <div class="test-section">
        <h2>1. 数据完整性测试</h2>
        <div id="data-test">
            <button onclick="testDataIntegrity()">测试数据完整性</button>
            <div id="data-results"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2. JavaScript 语法测试</h2>
        <div id="js-test">
            <button onclick="testJavaScriptSyntax()">测试JavaScript语法</button>
            <div id="js-results"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>3. 功能模块测试</h2>
        <div id="function-test">
            <button onclick="testFunctionality()">测试功能模块</button>
            <div id="function-results"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. 导航链接测试</h2>
        <div id="link-test">
            <button onclick="testNavigationLinks()">测试导航链接</button>
            <div id="link-results"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5. 综合状态</h2>
        <div id="overall-status">
            <button onclick="runAllTests()">运行所有测试</button>
            <div id="overall-results"></div>
        </div>
    </div>

    <script>
        // 测试数据完整性
        function testDataIntegrity() {
            const results = document.getElementById('data-results');
            results.innerHTML = '';
            
            try {
                // 测试人物数据
                if (typeof charactersData !== 'undefined') {
                    const charCount = Object.keys(charactersData).length;
                    addResult('人物数量', charCount >= 30, `找到 ${charCount} 个人物`);
                } else {
                    addResult('人物数据', false, 'charactersData 未定义');
                }
                
                // 测试成就数据
                if (typeof plotAchievements !== 'undefined') {
                    const achCount = Object.keys(plotAchievements).length;
                    addResult('成就数量', achCount >= 48, `找到 ${achCount} 个成就`);
                } else {
                    addResult('成就数据', false, 'plotAchievements 未定义');
                }
                
                // 测试分类配置
                if (typeof categoryConfig !== 'undefined') {
                    const catCount = Object.keys(categoryConfig).length;
                    addResult('分类数量', catCount >= 10, `找到 ${catCount} 个分类`);
                } else {
                    addResult('分类配置', false, 'categoryConfig 未定义');
                }
                
            } catch (error) {
                addResult('数据测试', false, `错误: ${error.message}`);
            }
        }
        
        // 测试JavaScript语法
        function testJavaScriptSyntax() {
            const results = document.getElementById('js-results');
            results.innerHTML = '';
            
            try {
                // 测试关键函数是否存在
                const functions = [
                    'initializeGraph', 'selectNode', 'deselectNode', 
                    'showCharacterDetails', 'hideCharacterDetails', 'selectCharacterById',
                    'showEvidenceModal', 'closeEvidenceModal', 'initializeCharacterList',
                    'initializeLegend', 'initializeControls', 'filterCharacters'
                ];
                
                functions.forEach(func => {
                    if (typeof window[func] === 'function') {
                        addResult(`${func} 函数`, true, '函数已定义');
                    } else {
                        addResult(`${func} 函数`, false, '函数未定义');
                    }
                });
                
                // 测试全局变量
                if (typeof svg !== 'undefined' || svg === null) {
                    addResult('SVG变量', true, 'SVG变量已声明');
                } else {
                    addResult('SVG变量', false, 'SVG变量未声明');
                }
                
            } catch (error) {
                addResult('语法测试', false, `错误: ${error.message}`);
            }
        }
        
        // 测试功能模块
        function testFunctionality() {
            const results = document.getElementById('function-results');
            results.innerHTML = '';
            
            try {
                // 测试关系颜色映射
                if (typeof relationshipColors !== 'undefined') {
                    const colorCount = Object.keys(relationshipColors).length;
                    addResult('关系颜色映射', colorCount >= 7, `找到 ${colorCount} 种关系颜色`);
                } else {
                    addResult('关系颜色映射', false, 'relationshipColors 未定义');
                }
                
                // 测试关系类型名称映射
                if (typeof relationshipTypeNames !== 'undefined') {
                    const typeCount = Object.keys(relationshipTypeNames).length;
                    addResult('关系类型名称', typeCount >= 7, `找到 ${typeCount} 种关系类型`);
                } else {
                    addResult('关系类型名称', false, 'relationshipTypeNames 未定义');
                }
                
                // 测试D3.js是否加载
                if (typeof d3 !== 'undefined') {
                    addResult('D3.js 库', true, 'D3.js 已加载');
                } else {
                    addResult('D3.js 库', false, 'D3.js 未加载');
                }
                
            } catch (error) {
                addResult('功能测试', false, `错误: ${error.message}`);
            }
        }
        
        // 测试导航链接
        function testNavigationLinks() {
            const results = document.getElementById('link-results');
            results.innerHTML = '';
            
            const pages = [
                { name: '导航页面', url: 'navigation.html' },
                { name: '人物关系图', url: 'index.html' },
                { name: '剧情成就系统', url: 'plot.html' },
                { name: '使用帮助', url: 'help.html' }
            ];
            
            pages.forEach(page => {
                // 创建测试链接
                const link = document.createElement('a');
                link.href = page.url;
                
                // 检查链接是否有效（简化检查）
                if (link.href && link.href !== '') {
                    addResult(`${page.name}`, true, `链接有效: ${page.url}`);
                } else {
                    addResult(`${page.name}`, false, `链接无效: ${page.url}`);
                }
            });
        }
        
        // 运行所有测试
        function runAllTests() {
            testDataIntegrity();
            testJavaScriptSyntax();
            testFunctionality();
            testNavigationLinks();
            
            // 显示综合状态
            const overallResults = document.getElementById('overall-results');
            overallResults.innerHTML = '<div class="test-result pass">所有测试已运行，请查看各部分的详细结果</div>';
        }
        
        // 添加测试结果
        function addResult(testName, passed, message) {
            const results = event.target.parentElement.querySelector('div[id$="-results"]');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `<strong>${testName}:</strong> ${passed ? '✅ 通过' : '❌ 失败'} - ${message}`;
            results.appendChild(resultDiv);
        }
        
        // 页面加载时自动运行基本测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('测试页面已加载');
            
            // 检查关键变量是否存在
            const checks = [
                { name: 'charactersData', obj: typeof charactersData },
                { name: 'plotAchievements', obj: typeof plotAchievements },
                { name: 'categoryConfig', obj: typeof categoryConfig },
                { name: 'relationshipColors', obj: typeof relationshipColors },
                { name: 'relationshipTypeNames', obj: typeof relationshipTypeNames }
            ];
            
            checks.forEach(check => {
                const status = check.obj !== 'undefined' ? '✅ 已定义' : '❌ 未定义';
                console.log(`${check.name}: ${status}`);
            });
        });
    </script>
</body>
</html>
